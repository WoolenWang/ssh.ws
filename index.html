<html>

<body>
You should probably load this from a webserver to avoid javascript permission problems.

<code>
$ python3 -m http.server
</code>
or
<code>
$ python2 -m SimpleHTTPServer
</code>

run in this directory will do what you need.

<div id="termDiv" style="width: 800; height: 800"></div>

</body>

<script src="/lib/require.js"></script>
<script>
// order taken from https://github.com/mimecuvalo/firessh/blob/master/src/content/firessh.xul


</script>
<!-- imports from FireSSH because paramikojs is not properly self-contained -->
<script type="application/x-javascript" src="/lib/paramikojs/globals.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/log.js"></script>

<!-- paramikojs -->
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/kryptos.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Cipher/AES.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Cipher/Blowfish.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Cipher/DES3.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Cipher/ARC4.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Hash/baseHash.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Hash/SHA.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Hash/SHA256.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Hash/MD5.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Hash/HMAC.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/PublicKey/RSA.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/PublicKey/DSA.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Random/_UserFriendlyRNG.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Random/Fortuna/SHAd256.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Random/Fortuna/FortunaAccumulator.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Random/Fortuna/FortunaGenerator.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kryptos/Random/OSRNG/browser.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/common.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/python_shim.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/BigInteger.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/agent.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/auth_handler.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/ber.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/channel.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/client.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/compress.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/dsskey.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/file.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/hostkeys.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kex_gex.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/kex_group1.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/message.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/packet.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/pkey.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/rsakey.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/sftp_attr.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/sftp_client.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/sftp_file.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/sftp.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/ssh_exception.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/transport.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/util.js"></script>
<script type="application/x-javascript" src="/lib/paramikojs/win_pageant.js"></script>



<script language="JavaScript" type="text/javascript" src="/lib/termlib.js"></script>
</head>

<script>

// WEBSOCKETS



var ws = new WebSocket("ws://localhost:8022", "base64") //ugh, base64, dammit
ws.onopen = function(evt) {
  console.info("websocket open")
}


ws.onclose = function(evt) {
  console.log("websocket closed")
}

ws.onerror = function(evt) {
  console.error(evt)
}

// PARAMIKO

var host = "localhost"
var port = 22;
var user = "kousu"
var password = null;

require(["password"]) // prompt("Enter your password (very insecurely)")


var client = new paramikojs.SSHClient()
client.set_missing_host_key_policy(new paramikojs.AskPolicy())

var observer = {} // I.. think .. this doesn't actually need methods? I hope??
observer.version = 0 // wtf. this is used *inside* to generate the welcome banner??
observer.onSftpCache = function(e) { console.log("onSftpCache:", e) }

function on_auth(e) {
  // use 'xterm' to get color
  // 'vt100' or blank for monochrome
  client.invoke_shell('xterm', 80, 50, on_shell)
}

var shell = null;
function on_shell(e) {
  console.log("successfully constructed a shell")
  shell = e;
  
  setInterval(poll_paramiko, 500);
}

// PARAMIKO <-> WEBSOCKETS
function on_write(data) {
  //console.log("SSHClient is sending", data)
  
  // XXX this should buffer until onopen happens!!!  
  //console.log("websocket write")
  ws.send(btoa(data))
}

function on_read(data) {
  //console.log(data)
  transport.fullBuffer += data;
  
  try {
    transport.run() // pump one iteration of the 'transport' event loop
  } catch(err) {
    console.error(err)
  }
}


ws.onmessage = function(evt) {
  //console.log("websocket read")
  on_read(atob(evt.data));
}

// plug PARAMIKO <-> WEBSOCKETS all together
var transport = client.connect(observer, on_write, on_auth, host, port, user, password, null, null);
transport.authenticatedCallback = function(e) {
  console.log("AUTHENTICATED_CALLBACK")
  console.info(e)
}
setTimeout(function() {
  transport.auth_password(user, password) //???? why does this have to be here? connect() seems to be ignoring this step??
  }, 1*1000);
/*var transport = new paramikojs.transport(observer); 
transport.writeCallback = on_write;
transport.use_compression(true)

//transport.connect(null, null, null, null, null, on_auth)

transport.auth_callback = function() {
}
//
transport.start_client()
*/

// TERMLIB
//TODO: figure out how to get termlib to resize itself...
  var term = new Terminal({rows: 24, greeting: "", crsrBlinkMode: true, handler: sshTermHandler, exitHandler: null ,
  ctrlHandler: MyctrlHandler,
  
     mapANSI: true, // support colors (?? except this doesn't seem to be working
     ps: "",  //disable built in prompt in favour of what ssh feeds us
     //charMode: true
     })
  
  //var term = new Terminal( {handler: termHandler, termDiv: "term"} );
  term.open();
  term._carriageReturn(); //UNDO the hardcoded prompt() call in term.init(); prompt, even if greeting is empty, calls "_charOut(1)" which I assume is what was making that ugly out of place indent
  term.charMode = true; //oh boy; setting charMode here vs up in the conf object BEHAVES DIFFERENTLY
  // setting it here makes it impossible to grab ctrl keys
  // setting it there ..doesn't seem to do anythign???
  
  
  function MyctrlHandler() {
    alert("CTRL")
    sshTermHandler()
  }
  
  function sshTermHandler() {    
    console.log("sending ", "|"+this.inputChar+"|")
    shell.send(String.fromCharCode(this.inputChar));
  }
  

Terminal.prototype._visualBell_On = false; //shittiest visual bell evar
Terminal.prototype.visualBell = function() {
  var self = this;
  if(self._visualBell_On) return;
  self._visualBell_On = true;
  self.setTextColor("red")
  setInterval(function() {
    self.setTextColor("green");
    self._visualBell_On = false;
  }, 50)
}

function write_termlib(data) {
  console.log("received ", "|"+data+"|")
  term.write(data)
}

function poll_paramiko() {
  try {
   var data = shell.recv(1<<15)
   write_termlib(data)
  } catch(ex) {
    if(ex instanceof paramikojs.ssh_exception.WaitException) {
      //pass
    } else {
      console.error(ex)
      throw ex;
    }
  }
}

// plug PARAMIKO <-> TERMLIB



</script>

<style>

.term {
	font-family: courier,fixed,swiss,sans-serif;
	font-size: 28px;
	color: #33d011;
	background: none;
}
.termReverse {
	color: #111111;
	background: #33d011;
}

body { background: #111111 }
</style>

</html>
